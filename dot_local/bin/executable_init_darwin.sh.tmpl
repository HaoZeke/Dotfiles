#!/usr/bin/env sh

# Helpers
chck() { command -v $1 > /dev/null && echo $? ; }

# Brew
command -v brew > /dev/null || { \
    echo "Homebrew not found, installing"  &&  \
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" \
;}

# Basics
# Always grab these, just in case
brew install git gh \
    openssh openssl \
    mosh ssh-copy-id \
    aria2 wget tree fzf \
    wakatime-cli neofetch \
    gfortran gcc borgbackup yq

# Encryption + TeX
set -- "brew" "age" "gpg-tui" \
    "tectonic" "biber"
for item in "$@"; do
    if [ $(chck "$item") ]; then
        echo "Found $item";
    else
        echo "Installing $item" && \
        brew install $item;
    fi;
done

# Bundle, mostly casks
brew bundle --force --file=/dev/stdin <<EOF
# Taps
tap "homebrew/core"
tap "homebrew/bundle"
tap "homebrew/cask" # GUI applications
tap "homebrew/cask-versions" # Alternates
tap "homebrew/services" # Integrates with launctl
tap "homebrew/cask-fonts" # Fonts
tap "buo/cask-upgrade" # Provides brew cu
brew "mas" # Mac App Store CLI

# Encryption
cask "enpass"
cask "cryptomator"
cask "keybase"
cask "authy"

# Tools
brew "direnv"
brew "svn"
brew "trash" # safer delete
brew "ngrep" # network sniffer
brew "coreutils" # has shuf
cask "keka" # Archiver
cask "hammerspoon" # System Control
cask "karabiner-elements" # Keyboard
cask "qview" # Image viewer
cask "alfred" # Launcher
brew "rsync" # Updated
cask "windscribe" # VPN
cask "oversight" # Monitor cam/mic
cask "tomighty" # Pomodoro
cask "macfuse" # Fuse mount
mas "Amphetamine", id: 937984704
mas "Tailscale", id: 1475387142
# brew "tailscale" # Local network

# Editors / Notes
cask "obsidian"
cask "visual-studio-code"
brew "neovim"
mas "Microsoft To Do", id: 1274495053
mas "Journey", id: 1300202543

# Development
mas "Xcode", id: 497799835
cask "docker" # Dev environments

# Personal Comm
mas "Telegram", id: 747648890
cask "whatsapp"
cask "zoom"
cask "mailmate"

# Work Comm
mas 'Slack', id: 803453959
cask "zulip"
cask "microsoft-teams"
cask "element"
cask "discord"
brew "pidgin" # For google chat
mas "Trillian", id: 412056820

# Terminals
cask "tabby"
cask "alacritty"
cask "termius"

# Research
cask "zotero"

# Readers
cask "remarkable"
cask "calibre"

# Trackers
cask "rescuetime"
cask "toggl-track"
mas Harvest, id: 506189836

# Browsers
cask "firefox-developer-edition"
cask "google-chrome"

# Backup
cask "resilio-sync"
cask "insync"

# Office
mas "Microsoft OneNote", id: 784801555
mas "Microsoft Excel", id: 462058435
mas "Microsoft Word", id: 462054704
mas "Microsoft PowerPoint", id: 462062816

# Media
cask "spotify"
cask "plex-media-player"
cask "smplayer"
mas "Prime Video", id: 545519333

# Media Editing
cask "obs"
cask "losslesscut"
cask "keycastr"
cask "inkscape" # also for conversions

# Fonts
brew "fontconfig"
cask "font-fontawesome"
cask "font-devicons"
cask "font-eb-garamond"

# Cascadia Code
cask "font-cascadia-code"
cask "font-cascadia-code-pl"
cask "font-cascadia-mono"
cask "font-cascadia-mono-pl"

# NerdFonts
cask "font-caskaydia-cove-nerd-font"
cask "font-hack-nerd-font"
cask "font-fira-mono-nerd-font"

EOF

# Silver searcher
command -v ag > /dev/null || { \
    brew install the_silver_searcher ; \
}

# Zathura
# https://github.com/zegervdv/homebrew-zathura
# https://gist.github.com/agzam/76d761804330cc8c4600fccda952ed1c
command -v zathura > /dev/null || { \
    brew tap zegervdv/zathura && \
    brew install zathura-pdf-mupdf zathura-djvu zathura-cb zathura-ps && \
    mkdir -p $(brew --prefix zathura)/lib/zathura  && \
    ln -s $(brew --prefix zathura-pdf-mupdf)/libpdf-mupdf.dylib $(brew --prefix zathura)/lib/zathura/libpdf-mupdf.dylib && \
    ln -s $(brew --prefix zathura-ps)/libps.dylib $(brew --prefix zathura)/lib/zathura/libps.dylib && \
    ln -s $(brew --prefix zathura-djvu)/libdjvu.dylib $(brew --prefix zathura)/lib/zathura/libdjvu.dylib && \
    ln -s $(brew --prefix zathura-cb)/libcb.dylib $(brew --prefix zathura)/lib/zathura/libcb.dylib \
;}

# Common includes
# Rust has a unified installer, for MacOS and Linux
# TODO: Handle Windows
{{- include "dot_local/bin/executable_init_rust.sh" -}}

# Emacs Stuff (cross platform)
# Local Variables:
# mode: shell-script
# End:
